<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Endpoint Security vulnerabilities and bugs | (b)logga</title>
    <meta name="description" content="A list of macOS vulnerabilities and bugs found while working on logga">
    <meta name="generator" content="VitePress v1.0.0-rc.43">
    <link rel="preload stylesheet" href="/blog/assets/style.BLOCGQfn.css" as="style">
    
    <script type="module" src="/blog/assets/app.B9nbNnjQ.js"></script>
    <link rel="preload" href="/blog/assets/inter-roman-latin.Bu8hRsVA.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/blog/assets/chunks/framework.BOOijfbL.js">
    <link rel="modulepreload" href="/blog/assets/chunks/theme.Cs793JK4.js">
    <link rel="modulepreload" href="/blog/assets/articles_endpoint-security-vulnerabilities-and-bugs.md.CRonryEH.lean.js">
    <link rel="icon" href="/assets/favicon.ico">
    <meta property="og:image" content="https://getlogga.com/blog_pages/assets/logo.png">
    <meta property="og:image:secure_url" content="https://getlogga.com/blog_pages/assets/logo.png">
    <meta property="og:image:alt" content="logga">
    <meta property="og:image:width" content="256">
    <meta property="og:image:height" content="256">
    <meta property="twitter:card" content="summary">
    <link rel="canonical" href="https://getlogga.com/blog">
    <meta name="keywords" content="audit log, access log, macOS, system extension, security blog, log forwarding, mac audit log, macos audit logs">
    <meta name="author" content="Peter Hasko-Nagy">
    <meta name="robots" content="index, archive, follow">
    <meta name="googlebot" content="index, follow">
    <meta property="og:site_name" content="logga">
    <meta name="twitter:site" content="@getlogga">
    <meta name="twitter:creator" content="@getlogga">
    <meta name="theme-color" content="#000000">
    <meta name="twitter:image" content="https://getlogga.com/blog_pages/assets/logo.png">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-43L53LES86"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-43L53LES86");</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
    <meta property="og:title" content="Endpoint Security vulnerabilities and bugs">
    <meta property="og:description" content="A list of macOS vulnerabilities and bugs found while working on logga">
    <meta property="description" content="A list of macOS vulnerabilities and bugs found while working on logga">
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-19c990f1><div class="wrapper" data-v-19c990f1><div class="container" data-v-19c990f1><div class="title" data-v-19c990f1><div class="VPNavBarTitle" data-v-19c990f1 data-v-ab179fa1><a class="title" href="/blog/" data-v-ab179fa1><!--[--><!--]--><!--[--><img class="VPImage logo" src="/blog/assets/logo.png" alt data-v-8426fc1a><!--]--><span data-v-ab179fa1>(b)logga</span><!--[--><!--]--></a></div></div><div class="content" data-v-19c990f1><div class="content-body" data-v-19c990f1><!--[--><!--]--><div class="VPNavBarSearch search" data-v-19c990f1><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-19c990f1 data-v-7f418b0f><span id="main-nav-aria-label" class="visually-hidden" data-v-7f418b0f>Main Navigation</span><!--[--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://getlogga.com" target="_blank" rel="noreferrer" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>home</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://docs.getlogga.com" target="_blank" rel="noreferrer" tabindex="0" data-v-7f418b0f data-v-42ef59de><!--[--><span data-v-42ef59de>docs</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-19c990f1 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-e6aabb21 data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-19c990f1 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/logga-app" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-19c990f1 data-v-d0bd9dde data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b6c34ac9><span class="vpi-more-horizontal icon" data-v-b6c34ac9></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-d0bd9dde><div class="item appearance" data-v-d0bd9dde><p class="label" data-v-d0bd9dde>Appearance</p><div class="appearance-action" data-v-d0bd9dde><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-d0bd9dde data-v-d1f28634 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-d1f28634></span><span class="vpi-moon moon" data-v-d1f28634></span><!--]--></span></span></button></div></div></div><div class="group" data-v-d0bd9dde><div class="item social-links" data-v-d0bd9dde><div class="VPSocialLinks social-links-list" data-v-d0bd9dde data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/logga-app" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-19c990f1 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-19c990f1><div class="divider-line" data-v-19c990f1></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-d2ecc192><button data-v-d2ecc192>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-935f8a84><div class="content" data-v-935f8a84><div class="outline-marker" data-v-935f8a84></div><div class="outline-title" role="heading" aria-level="2" data-v-935f8a84>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-935f8a84><span class="visually-hidden" id="doc-outline-aria-label" data-v-935f8a84> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-935f8a84 data-v-b933a997><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _blog_articles_endpoint-security-vulnerabilities-and-bugs" data-v-39a288b8><div><h1 id="endpoint-security-vulnerabilities-and-bugs" tabindex="-1">Endpoint Security vulnerabilities and bugs <a class="header-anchor" href="#endpoint-security-vulnerabilities-and-bugs" aria-label="Permalink to &quot;Endpoint Security vulnerabilities and bugs&quot;">​</a></h1><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Before publishing, the logga team reported all of these findings (and possible exploits) to Apple. They did not deem any of them dangerous, but we will showcase the opposite.</p></div><h2 id="_1-bypassing-the-systemextension-user-consent-prompt" tabindex="-1">1. Bypassing the SystemExtension user consent prompt <a class="header-anchor" href="#_1-bypassing-the-systemextension-user-consent-prompt" aria-label="Permalink to &quot;1. Bypassing the SystemExtension user consent prompt&quot;">​</a></h2><p>The Endpoint Security framework is a special, &quot;protected&quot; library, as it gives access to sensitive system information. In order to be able to use it in an application, first the developer needs to request access from Apple. Then, the application must be packaged as a System Extension application: the Endpoint Security binary itself, plus an accompanying GUI application whose sole purpose is to load the Endpoint Security binary. The user is presented with a Consent Prompt as soon as the Endpoint Security binary is loaded.</p><p><img src="/blog/assets/consent.CMa-k2vN.png" alt="Consent Prompt"></p><p>It happens for a reason: the application cannot and should not load a sensitive library without the user knowing it. Imagine if (for example) the Spotify app would collect file access information from your system without you knowing it.</p><p>Technically, packaging an application as a System Extension is not the only way of running an Endpoint Security-included binary. One can create a simple Command Line application (that uses ES) and package it as a GUI macOS application. When invoked, the application shows <strong>NO</strong> Consent Prompt. The only caveat is that the invoking process must have Full Disk Access. The bad news is that most developers with a MacBook have Full Disk Access enabled for either Terminal.app, iTerm, or sshd-keygen-wrapper, etc. There are multiple ways (supply chain attacks) to run our malicious application (without user consent) invoked by some of the FDA-enabled applications.</p><p>Apple dismissed our concern pointing to the Full Disk Access requirement. Dear developer, it is time to check your FDA settings 👀.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Disclaimer: We think @theevilbit also mentions this problem in his 2022 <a href="https://theevilbit.github.io/talks_workshops/2022/OBTS2022-Fitzl-The-Achilles-heel-of-EndpointSecurity.pdf" target="_blank" rel="noreferrer">talk</a>.</p></div><h2 id="_2-bypassing-the-systemextension-user-consent-prompt-2" tabindex="-1">2. Bypassing the SystemExtension user consent prompt #2 <a class="header-anchor" href="#_2-bypassing-the-systemextension-user-consent-prompt-2" aria-label="Permalink to &quot;2. Bypassing the SystemExtension user consent prompt #2&quot;">​</a></h2><p>This finding is really similar to the previous one. This time the malicious application will be invoked by a LaunchDaemon, and the application needs to have Full Disk Access. Picture this:</p><ul><li>We create a fully innocent, useful application to gain user trust.</li><li>Many people install our app, and it becomes generally accepted as a trustworthy application.</li><li>One day (probably after a new release), our app asks for Full Disk Access, but users don&#39;t suspect anything: they have been using it for some time now.</li><li>With the next release, we release a pkg that installs the malicious binary &amp; loads a LaunchDaemon.</li><li>The user has no idea what just happened. (They may see the Login item notification)</li></ul><h2 id="_3-modifying-tcc-db-entry-for-invoking-process" tabindex="-1">3. Modifying TCC.db entry for invoking process <a class="header-anchor" href="#_3-modifying-tcc-db-entry-for-invoking-process" aria-label="Permalink to &quot;3. Modifying TCC.db entry for invoking process&quot;">​</a></h2><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Transparency, Consent, and Control is a macOS mechanism to limit application access to other applications or system features (such as Full Disk Access).</p></div><p>We do something really similar to point 1: invoke an Endpoint Security binary by a process that has FDA enabled. Let&#39;s say we invoke logga-daemon from the Terminal.app (that has FDA enabled).</p><h3 id="tcc-db-before-invocation" tabindex="-1">TCC.db before invocation: <a class="header-anchor" href="#tcc-db-before-invocation" aria-label="Permalink to &quot;TCC.db before invocation:&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>kTCCServiceSystemPolicyAllFiles|com.apple.Terminal|0|2|4|1|��</span></span>
<span class="line"><span>                                                               ||0|UNUSED||0|1678405207|||UNUSED|0</span></span></code></pre></div><h3 id="tcc-db-after-invocation" tabindex="-1">TCC.db after invocation: <a class="header-anchor" href="#tcc-db-after-invocation" aria-label="Permalink to &quot;TCC.db after invocation:&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>kTCCServiceEndpointSecurityClient|com.apple.Terminal|0|2|4|1|��</span></span>
<span class="line"><span>                                                               ||0|UNUSED||0|1678405207|||UNUSED|0</span></span></code></pre></div><p>The same happens with iTerm or sshd-keygen-wrapper (or with any process that can invoke another). According to @theevilbit, <code>kTCCServiceEndpointSecurityClient</code> was called <code>kTCCServiceSystemPolicyAllFiles</code> earlier, so the two keys are essentially equivalent. We did not investigate if this &quot;bug&quot; is exploitable, as this is not our thing.</p><h2 id="closing" tabindex="-1">Closing <a class="header-anchor" href="#closing" aria-label="Permalink to &quot;Closing&quot;">​</a></h2><p>Working on logga is a pretty rewarding journey with many detours. The logga team pledges to contribute to macOS security in any way we can, be it audit logging or bug reporting.</p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-09de1c0f><!--[--><!--]--><!----><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"articles_configuring-logga-with-mdm-profiles.md\":\"h3uBpEJ4\",\"articles_compressing-rotated-log-files.md\":\"B0jWjXKe\",\"index.md\":\"C1KCkAZp\",\"articles_endpoint-security-vulnerabilities-and-bugs.md\":\"CRonryEH\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"(b)logga\",\"description\":\"A combination of our changelog, marketing content and other posts, where we talk about logga, macos audit logging, and other macos security or log related topics.\",\"base\":\"/blog/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/assets/logo.png\",\"nav\":[{\"text\":\"home\",\"link\":\"https://getlogga.com\"},{\"text\":\"docs\",\"link\":\"https://docs.getlogga.com\"}],\"sidebar\":[],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/logga-app\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>