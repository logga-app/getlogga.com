import{_ as e,c as i,o as t,a2 as a}from"./chunks/framework.BOOijfbL.js";const n="/blog/assets/consent.CMa-k2vN.png",y=JSON.parse('{"title":"Endpoint Security vulnerabilities and bugs","description":"A list of macOS vulnerabilities and bugs found while working on logga","frontmatter":{"outline":"deep","title":"Endpoint Security vulnerabilities and bugs","description":"A list of macOS vulnerabilities and bugs found while working on logga"},"headers":[],"relativePath":"articles/endpoint-security-vulnerabilities-and-bugs.md","filePath":"articles/endpoint-security-vulnerabilities-and-bugs.md"}'),s={name:"articles/endpoint-security-vulnerabilities-and-bugs.md"},o=a('<h1 id="endpoint-security-vulnerabilities-and-bugs" tabindex="-1">Endpoint Security vulnerabilities and bugs <a class="header-anchor" href="#endpoint-security-vulnerabilities-and-bugs" aria-label="Permalink to &quot;Endpoint Security vulnerabilities and bugs&quot;">â€‹</a></h1><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Before publishing, the logga team reported all of these findings (and possible exploits) to Apple. They did not deem any of them dangerous, but we will showcase the opposite.</p></div><h2 id="_1-bypassing-the-systemextension-user-consent-prompt" tabindex="-1">1. Bypassing the SystemExtension user consent prompt <a class="header-anchor" href="#_1-bypassing-the-systemextension-user-consent-prompt" aria-label="Permalink to &quot;1. Bypassing the SystemExtension user consent prompt&quot;">â€‹</a></h2><p>The Endpoint Security framework is a special, &quot;protected&quot; library, as it gives access to sensitive system information. In order to be able to use it in an application, first the developer needs to request access from Apple. Then, the application must be packaged as a System Extension application: the Endpoint Security binary itself, plus an accompanying GUI application whose sole purpose is to load the Endpoint Security binary. The user is presented with a Consent Prompt as soon as the Endpoint Security binary is loaded.</p><p><img src="'+n+`" alt="Consent Prompt"></p><p>It happens for a reason: the application cannot and should not load a sensitive library without the user knowing it. Imagine if (for example) the Spotify app would collect file access information from your system without you knowing it.</p><p>Technically, packaging an application as a System Extension is not the only way of running an Endpoint Security-included binary. One can create a simple Command Line application (that uses ES) and package it as a GUI macOS application. When invoked, the application shows <strong>NO</strong> Consent Prompt. The only caveat is that the invoking process must have Full Disk Access. The bad news is that most developers with a MacBook have Full Disk Access enabled for either Terminal.app, iTerm, or sshd-keygen-wrapper, etc. There are multiple ways (supply chain attacks) to run our malicious application (without user consent) invoked by some of the FDA-enabled applications.</p><p>Apple dismissed our concern pointing to the Full Disk Access requirement. Dear developer, it is time to check your FDA settings ðŸ‘€.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Disclaimer: We think @theevilbit also mentions this problem in his 2022 <a href="https://theevilbit.github.io/talks_workshops/2022/OBTS2022-Fitzl-The-Achilles-heel-of-EndpointSecurity.pdf" target="_blank" rel="noreferrer">talk</a>.</p></div><h2 id="_2-bypassing-the-systemextension-user-consent-prompt-2" tabindex="-1">2. Bypassing the SystemExtension user consent prompt #2 <a class="header-anchor" href="#_2-bypassing-the-systemextension-user-consent-prompt-2" aria-label="Permalink to &quot;2. Bypassing the SystemExtension user consent prompt #2&quot;">â€‹</a></h2><p>This finding is really similar to the previous one. This time the malicious application will be invoked by a LaunchDaemon, and the application needs to have Full Disk Access. Picture this:</p><ul><li>We create a fully innocent, useful application to gain user trust.</li><li>Many people install our app, and it becomes generally accepted as a trustworthy application.</li><li>One day (probably after a new release), our app asks for Full Disk Access, but users don&#39;t suspect anything: they have been using it for some time now.</li><li>With the next release, we release a pkg that installs the malicious binary &amp; loads a LaunchDaemon.</li><li>The user has no idea what just happened. (They may see the Login item notification)</li></ul><h2 id="_3-modifying-tcc-db-entry-for-invoking-process" tabindex="-1">3. Modifying TCC.db entry for invoking process <a class="header-anchor" href="#_3-modifying-tcc-db-entry-for-invoking-process" aria-label="Permalink to &quot;3. Modifying TCC.db entry for invoking process&quot;">â€‹</a></h2><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Transparency, Consent, and Control is a macOS mechanism to limit application access to other applications or system features (such as Full Disk Access).</p></div><p>We do something really similar to point 1: invoke an Endpoint Security binary by a process that has FDA enabled. Let&#39;s say we invoke logga-daemon from the Terminal.app (that has FDA enabled).</p><h3 id="tcc-db-before-invocation" tabindex="-1">TCC.db before invocation: <a class="header-anchor" href="#tcc-db-before-invocation" aria-label="Permalink to &quot;TCC.db before invocation:&quot;">â€‹</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>kTCCServiceSystemPolicyAllFiles|com.apple.Terminal|0|2|4|1|ï¿½ï¿½</span></span>
<span class="line"><span>                                                               ||0|UNUSED||0|1678405207|||UNUSED|0</span></span></code></pre></div><h3 id="tcc-db-after-invocation" tabindex="-1">TCC.db after invocation: <a class="header-anchor" href="#tcc-db-after-invocation" aria-label="Permalink to &quot;TCC.db after invocation:&quot;">â€‹</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>kTCCServiceEndpointSecurityClient|com.apple.Terminal|0|2|4|1|ï¿½ï¿½</span></span>
<span class="line"><span>                                                               ||0|UNUSED||0|1678405207|||UNUSED|0</span></span></code></pre></div><p>The same happens with iTerm or sshd-keygen-wrapper (or with any process that can invoke another). According to @theevilbit, <code>kTCCServiceEndpointSecurityClient</code> was called <code>kTCCServiceSystemPolicyAllFiles</code> earlier, so the two keys are essentially equivalent. We did not investigate if this &quot;bug&quot; is exploitable, as this is not our thing.</p><h2 id="closing" tabindex="-1">Closing <a class="header-anchor" href="#closing" aria-label="Permalink to &quot;Closing&quot;">â€‹</a></h2><p>Working on logga is a pretty rewarding journey with many detours. The logga team pledges to contribute to macOS security in any way we can, be it audit logging or bug reporting.</p>`,22),l=[o];function r(p,c,d,h,u,m){return t(),i("div",null,l)}const g=e(s,[["render",r]]);export{y as __pageData,g as default};
